<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIDA - Asistente de Donaci√≥n</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Roboto as requested -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles and Animations -->
    <style>
        /* New Color Palette and Font from the design specification */
        :root {
            --vida-bg: #E3F2FD; /* Azul cielo claro */
            --vida-text-dark: #0D47A1; /* Azul oscuro m√©dico */
            --vida-btn-green: #66BB6A; /* Verde esperanza suave */
            --vida-btn-green-hover: #43A047;
            --vida-text-secondary: #757575; /* Gris medio */
            --vida-bg-footer: #F5F5F5; /* Gris claro */
            --vida-chat-bot-bg: #F9F9F9; /* Gris claro para burbuja del bot */
            --vida-chat-user-bg: #E8F5E9; /* Verde muy claro para burbuja de usuario */
            --vida-btn-feedback: #4FC3F7; /* Azul cielo para feedback */
            --vida-suggest-btn-bg: #E0F2F7; /* Azul muy claro para bot√≥n de sugerencia */
            --vida-suggest-btn-hover: #B3E5FC; /* Azul m√°s claro para hover */
            --vida-module-btn-bg: #E0F2F7; /* Color para botones de m√≥dulo */
            --vida-module-btn-hover: #B3E5FC; /* Color hover para botones de m√≥dulo */
            --vida-module-btn-text: #0D47A1; /* Color de texto para botones de m√≥dulo */
            --vida-quiz-btn-correct: #4CAF50; /* Verde para respuesta correcta */
            --vida-quiz-btn-incorrect: #F44336; /* Rojo para respuesta incorrecta */
            --vida-quiz-btn-disabled: #BDBDBD; /* Gris para botones deshabilitados */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--vida-bg);
        }
        
        /* Fade-in animation for a smooth load */
        .fade-in-element {
            opacity: 0;
            animation: fadeIn 1s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Justify chat text */
        .chat-bubble-text {
            text-align: justify;
        }
        
        /* Custom scrollbar for chat */
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: #FFFFFF; }
        .chat-messages::-webkit-scrollbar-thumb { background: #BDBDBD; border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: var(--vida-text-secondary); }

        /* Initially hide these screens/modals */
        #chat-screen, #about-modal, #feedback-modal { display: none; }
        
        /* Styles for radio buttons in feedback form */
        .feedback-radio-group label {
            display: block;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        /* Styles for quiz question card */
        .quiz-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-top: 1rem;
            text-align: center;
        }

        .quiz-buttons button {
            transition: all 0.2s;
        }

        /* Styling for the custom SVG robot */
        /* Base styles for the SVG robot to ensure consistent appearance */
        .robot-svg-icon { /* Class for the SVG element itself */
            width: 100%;
            height: 100%;
        }
        .robot-svg-icon .heart-icon {
            fill: #EF5350; /* Red heart */
        }
        .robot-svg-icon .head-shape, .robot-svg-icon .torso {
            fill: #FFFFFF; /* White parts */
            stroke: #D1D5DB; /* Light gray border */
            stroke-width: 2;
        }
        .robot-svg-icon .neck {
            fill: #90A4AE; /* Gray neck */
        }
        .robot-svg-icon .arm-left, .robot-svg-icon .arm-right {
            stroke: #42A5F5; /* Blue arms */
            stroke-width: 15;
            fill: none;
            stroke-linecap: round;
        }
        .robot-svg-icon .screen {
            fill: #1F2937; /* Dark screen */
            rx: 10;
        }
        .robot-svg-icon .eye {
            fill: #40C4FF; /* Light blue eyes */
        }
        .robot-svg-icon .smile {
            stroke: #40C4FF; /* Light blue smile */
            stroke-width: 1.5;
            fill: none;
            stroke-linecap: round;
        }

        /* Animations for the robot SVG */
        @keyframes float-animation {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        @keyframes heart-beat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes typing-animation {
            0% { transform: translateY(0px); }
            25% { transform: translateY(-2px); }
            50% { transform: translateY(0px); }
            75% { transform: translateY(-2px); }
            100% { transform: translateY(0px); }
        }
        
        /* Apply animations to specific elements by ID or Class for different contexts */
        #main-robot-container svg { /* Target the SVG inside the main container */
            animation: float-animation 3s ease-in-out infinite;
        }
        /* Specific targeting for heart and head within message/typing indicator SVGs */
        .message-robot-avatar .heart-icon {
            animation: heart-beat 1.5s infinite;
        }
        .typing-indicator-robot .head {
            animation: typing-animation 0.7s infinite;
        }

    </style>
</head>
<body class="text-slate-800 antialiased">

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="w-full p-4 sm:p-5 bg-transparent fade-in-element" style="animation-delay: 0.2s;">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-[var(--vida-text-dark)] rounded-full flex items-center justify-center shadow">
                         <!-- Heart Icon for VIDA logo -->
                         <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </div>
                    <h1 class="text-3xl font-bold text-[var(--vida-text-dark)]">VIDA</h1>
                </div>
                <!-- About button -->
                <button id="about-btn" class="text-[var(--vida-text-dark)] font-semibold py-2 px-4 rounded-lg transition hover:bg-blue-200/50">¬øQu√© es esta app?</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col lg:flex-row items-center justify-center container mx-auto p-6 text-center lg:text-left gap-8">
            <div class="lg:w-full flex flex-col items-center lg:items-start"> <!-- Adjusted width to take full space -->
                <h2 class="text-3xl md:text-4xl lg:text-5xl font-bold text-[var(--vida-text-dark)] max-w-xl fade-in-element" style="animation-delay: 0.4s;">
                    Voz de Informaci√≥n y Donaci√≥n Asistida
                </h2>
                <p class="text-lg md:text-xl text-slate-600 mt-4 max-w-xl fade-in-element" style="animation-delay: 0.6s;">
                    Tu aliado informativo en momentos cr√≠ticos. Estoy aqu√≠ para ayudarte a tomar decisiones claras, humanas y fundamentadas.
                </p>
                <div class="mt-12 flex flex-col sm:flex-row gap-4 fade-in-element" style="animation-delay: 0.8s;">
                    <button id="start-chat-btn" class="bg-[var(--vida-btn-green)] text-white font-bold py-4 px-8 rounded-full shadow-lg hover:bg-[var(--vida-btn-green-hover)] transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
                        Iniciar conversaci√≥n
                    </button>
                    <!-- New Quiz Module Button -->
                    <button id="start-quiz-btn" class="bg-[var(--vida-btn-feedback)] text-white font-bold py-4 px-8 rounded-full shadow-lg hover:bg-blue-400 transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 flex items-center justify-center gap-2">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-3.87 0-7 3.13-7 7 0 3.73 2.7 6.84 6.3 7.64V22h1.4c.26 0 .5-.11.6-.33.15-.36-.04-.77-.4-.92L11.5 20h1v-1.12c3.6-1.12 6.3-4.23 6.3-7.64 0-3.87-3.13-7-7-7zm0 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                        ¬øQu√© tanto sabes sobre donar?
                    </button>
                </div>
            </div>
            <!-- Robot SVG for the main page, centered -->
            <div id="main-robot-container" class="lg:w-1/2 flex items-center justify-center mt-12 lg:mt-0 fade-in-element" style="animation-delay: 1s;">
                 <!-- The SVG will be inserted here directly by JavaScript -->
            </div>
        </main>

        <footer class="w-full p-4 bg-[var(--vida-bg-footer)] fade-in-element" style="animation-delay: 1.2s;">
            <div class="container mx-auto text-center">
                <p class="text-xs text-[var(--vida-text-secondary)]">
                    VIDA es una herramienta informativa. No sustituye la atenci√≥n m√©dica directa. Versi√≥n piloto para orientaci√≥n en procesos de donaci√≥n post mortem.
                </p>
            </div>
        </footer>
    </div>
    
    <button id="feedback-btn" class="fixed bottom-5 left-5 bg-[var(--vida-btn-feedback)] text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:scale-105 transition-transform z-20 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.08-3.239A8.939 8.939 0 012 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM4.416 11.603a.75.75 0 00-.029.048l.029-.048zM5.022 13.013a.75.75 0 00.213.024l.028-.024z" clip-rule="evenodd" /></svg>
        Danos tu opini√≥n
    </button>
    
    <div id="about-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-8 relative">
            <button id="close-about-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h3 class="text-2xl font-bold text-[var(--vida-text-dark)] mb-4">¬øQu√© es VIDA?</h3>
            <p class="text-slate-700">VIDA es un asistente conversacional dise√±ado para brindar informaci√≥n clara, fundada y humana sobre la donaci√≥n de √≥rganos y tejidos en M√©xico, espec√≠ficamente en situaciones de muerte encef√°lica y parada card√≠aca.</p>
        </div>
    </div>
    
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-8 relative overflow-hidden">
            <div id="feedback-form-container">
                 <button id="close-feedback-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
                <h3 class="text-2xl font-bold text-[var(--vida-text-dark)] mb-2">Encuesta an√≥nima de satisfacci√≥n ‚Äì VIDA</h3>
                <p class="text-sm text-gray-500 mb-6">Responde en menos de 1 minuto:</p>
                <form id="feedback-form">
                    <div class="space-y-6">
                        <div>
                            <p class="font-semibold text-gray-700 mb-2">1. ¬øLa informaci√≥n que recibiste fue clara y √∫til?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group">
                                <label><input type="radio" name="clarity" value="si" class="mr-2" required> S√≠</label>
                                <label><input type="radio" name="clarity" value="parcialmente" class="mr-2"> Parcialmente</label>
                                <label><input type="radio" name="clarity" value="no" class="mr-2"> No</label>
                            </div>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700 mb-2">2. ¬øEl lenguaje utilizado te pareci√≥ comprensible?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group">
                                <label><input type="radio" name="language" value="si" class="mr-2" required> S√≠</label>
                                <label><input type="radio" name="language" value="regular" class="mr-2"> Regular</label>
                                <label><input type="radio" name="language" value="dificil" class="mr-2"> Dif√≠cil de entender</label>
                            </div>
                        </div>
                         <div>
                            <p class="font-semibold text-gray-700 mb-2">3. ¬øTe ayud√≥ a resolver tus dudas sobre donaci√≥n?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group">
                                <label><input type="radio" name="solved_doubts" value="si" class="mr-2" required> S√≠ completamente</label>
                                <label><input type="radio" name="solved_doubts" value="algunas" class="mr-2"> Algunas</label>
                                <label><input type="radio" name="solved_doubts" value="no" class="mr-2"> No</label>
                            </div>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700 mb-2">4. ¬øRecomendar√≠as esta herramienta a otros usuarios?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group">
                                <label><input type="radio" name="recommend" value="si" class="mr-2" required> S√≠</label>
                                <label><input type="radio" name="recommend" value="no" class="mr-2"> No</label>
                            </div>
                        </div>
                        <div>
                            <label for="comments" class="font-semibold text-gray-700 mb-2 block">Comentarios adicionales</label>
                            <textarea id="comments" name="comments" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--vida-btn-feedback)]"></textarea>
                        </div>
                    </div>
                    <div class="mt-8 text-right">
                        <button type="submit" class="bg-[var(--vida-btn-green)] text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colors">Enviar respuesta</button>
                    </div>
                </form>
            </div>
             <div id="feedback-thanks" class="hidden text-center">
                <svg class="mx-auto h-16 w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h3 class="mt-4 text-2xl font-bold text-[var(--vida-text-dark)]">¬°Gracias!</h3>
                <p class="mt-2 text-gray-600">Tu opini√≥n nos importa y nos ayuda a mejorar VIDA.</p>
            </div>
        </div>
    </div>


    <div id="chat-screen" class="fixed inset-0 bg-slate-100 flex items-center justify-center p-0 sm:p-4 z-40 transition-opacity duration-300 opacity-0">
        <div class="w-full h-full sm:max-w-4xl sm:h-[90vh] bg-white sm:rounded-2xl shadow-2xl flex flex-col">
            <header class="bg-white border-b border-gray-200 p-4 sm:rounded-t-2xl flex items-center justify-between shadow-sm">
                 <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-[var(--vida-text-dark)] rounded-full flex items-center justify-center mr-1">
                        <svg class="h-7 w-7 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-[var(--vida-text-dark)]">VIDA</h2>
                        <p class="text-sm text-[var(--vida-text-secondary)]">Asistente de donaci√≥n</p>
                    </div>
                </div>
                <button id="close-chat-btn" class="text-gray-500 hover:bg-gray-200 p-2 rounded-full">
                     <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </header>
            <main class="flex-1 flex overflow-hidden">
                <div id="chat-container-wrapper" class="flex-1 flex flex-col p-4 sm:p-6 overflow-y-auto chat-messages">
                     <div id="chat-container" class="flex flex-col space-y-4"></div>
                </div>
                <aside class="w-1/3 bg-slate-50 p-6 border-l border-slate-200 hidden md:flex flex-col items-center justify-center">
                    <!-- chat-robot-avatar element: using the provided SVG for the large avatar -->
                    <div id="chat-robot-avatar-large" class="w-48 h-48 mb-4 rounded-full flex items-center justify-center shadow-lg overflow-hidden">
                        <!-- SVG will be inserted here by JavaScript -->
                    </div>
                    <div class="text-center">
                        <h3 class="font-bold text-lg text-[var(--vida-text-dark)]">Estoy para ayudarte</h3>
                        <p class="text-sm text-[var(--vida-text-secondary)] mt-1">Preg√∫ntame sobre el proceso de donaci√≥n de √≥rganos y tejidos.</p>
                    </div>
                </aside>
            </main>
            <footer class="p-4 bg-white border-t border-gray-200 sm:rounded-b-2xl">
                <div id="suggested-questions-container" class="flex flex-wrap gap-2 mb-4 hidden"></div>

                <form id="chat-form" class="flex items-center space-x-3">
                    <button type="button" id="suggest-questions-btn" class="bg-[var(--vida-suggest-btn-bg)] text-[var(--vida-text-dark)] rounded-full p-2.5 
                                        hover:bg-[var(--vida-suggest-btn-hover)] transition-colors focus:outline-none focus:ring-4 focus:ring-blue-100 
                                        disabled:bg-gray-200 disabled:cursor-not-allowed flex items-center justify-center">
                        <svg class="h-5 w-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-3.87 0-7 3.13-7 7 0 3.73 2.7 6.84 6.3 7.64V22h1.4c.26 0 .5-.11.6-.33.15-.36-.04-.77-.4-.92L11.5 20h1v-1.12c3.6-1.12 6.3-4.23 6.3-7.64 0-3.87-3.13-7-7-7zm0 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                        <span id="suggest-button-text" class="ml-1 text-sm font-semibold">Sugiere</span> </button>
                    <input type="text" id="chat-input" placeholder="Escribe tu pregunta aqu√≠..." autocomplete="off" class="flex-1 w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[var(--vida-btn-green)] transition">
                    <button type="submit" class="bg-[var(--vida-btn-green)] text-white rounded-full p-3 hover:bg-[var(--vida-btn-green-hover)] transition-transform transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-green-200 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                    </button>
                </form>
            </footer>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatScreen = document.getElementById('chat-screen');
        const startChatBtn = document.getElementById('start-chat-btn');
        // New button for Desmitificador Express on welcome screen
        const startQuizBtn = document.getElementById('start-quiz-btn'); 

        const chatContainer = document.getElementById('chat-container');
        const chatContainerWrapper = document.getElementById('chat-container-wrapper');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const aboutBtn = document.getElementById('about-btn');
        const closeModalBtn = document.getElementById('close-about-modal-btn');
        const aboutModal = document.getElementById('about-modal');
        const closeChatBtn = document.getElementById('close-chat-btn');
        // Removed robotImage element from the main page as per user request.
        // const robotImage = document.getElementById('robot-image'); 
        const feedbackBtn = document.getElementById('feedback-btn'); // Corrected ID selection
        const feedbackModal = document.getElementById('feedback-modal');
        const closeFeedbackModalBtn = document.getElementById('close-feedback-modal-btn');
        const feedbackForm = document.getElementById('feedback-form');
        const feedbackFormContainer = document.getElementById('feedback-form-container');
        const feedbackThanks = document.getElementById('feedback-thanks');
        const suggestQuestionsBtn = document.getElementById('suggest-questions-btn'); 
        const suggestedQuestionsContainer = document.getElementById('suggested-questions-container'); 
        const suggestButtonText = document.getElementById('suggest-button-text'); 

        // --- State ---
        let chatHistory = [];
        let currentDonorPathStep = null; // Tracks the current step in the "Tu Camino como Donante" module
        let currentQuizQuestionIndex = -1; // -1 means not in quiz, 0-9 for questions
        let quizQuestions = []; // Stores the generated quiz questions
        let currentIndecisionStep = null; // State for the indecision module
        let currentGriefStep = null; // New state for the grief module
        let currentFamilyDonationStep = null; // New state for family donation module

        // SVG string for the robot avatar
        const robotSvgHtml = `
            <svg class="robot-svg-icon" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <g>
                    <!-- Sombra -->
                    <ellipse cx="100" cy="185" rx="70" ry="10" fill="rgba(0,0,0,0.1)"/>
                    <!-- Torso -->
                    <path class="torso" d="M100 80C65 80 40 105 40 135v20c0 15 25 25 60 25s60-10 60-25v-20c0-30-25-55-60-55Z" fill="#FFFFFF" stroke="#D1D5DB" stroke-width="2"/>
                    <!-- Cuello -->
                    <rect class="neck" x="90" y="70" width="20" height="15" fill="#90A4AE"/>
                    <!-- Coraz√≥n -->
                    <path class="heart-icon" transform-origin="center" d="M100,120 C93.3,115 80,115 73.3,120 C60,130 73.3,145 100,160 C126.7,145 140,130 126.7,120 C120,115 106.7,115 100,120Z" fill="#EF5350"/>

                    <!-- Brazos -->
                    <g class="arms">
                        <!-- Brazo Izquierdo -->
                        <path class="arm-left" d="M50 100 C35 100 25 115 35 135" stroke="#42A5F5" stroke-width="15" fill="none" stroke-linecap="round"/>
                        <!-- Brazo Derecho -->
                        <g>
                                <path class="arm-right" d="M150 100 C165 100 175 115 165 135" stroke="#42A5F5" stroke-width="15" fill="none" stroke-linecap="round"/>
                        </g>
                    </g>
                    
                    <!-- Cabeza -->
                    <g class="head">
                        <circle class="head-shape" cx="100" cy="45" r="40" fill="#FFFFFF" stroke="#D1D5DB" stroke-width="2"/>
                        <!-- Pantalla -->
                        <rect class="screen" x="70" y="25" width="60" height="40" rx="10" fill="#1F2937"/>
                        <!-- Ojos -->
                        <circle class="eye left-eye" cx="88" cy="50" r="5" fill="#40C4FF"/>
                        <circle class="eye right-eye" cx="112" cy="50" r="5" fill="#40C4FF"/>
                        <!-- Sonrisa -->
                        <path class="smile" d="M90 65 Q100 68 110 65" stroke="#40C4FF" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                    </g>
                </g>
            </svg>
        `;

        // Function to create an SVG element from a string
        function createSvgElementFromString(svgString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(svgString, "image/svg+xml");
            return doc.documentElement; // Returns the <svg> element
        }

        // --- Initial DOM insertion of main robot SVG ---
        document.addEventListener('DOMContentLoaded', () => {
            const mainRobotContainer = document.getElementById('main-robot-container');
            if (mainRobotContainer) {
                // Clear previous content in case of re-rendering or multiple DOMContentLoaded calls
                mainRobotContainer.innerHTML = ''; 
                const svgElement = createSvgElementFromString(robotSvgHtml);
                // Apply specific size classes and shadow/padding for the main robot SVG directly
                // Removed bg-white here, shadow-lg, and p-4 from the div, apply to SVG directly
                svgElement.classList.add('w-64', 'h-64', 'md:w-80', 'md:h-80', 'rounded-full', 'shadow-lg'); 
                mainRobotContainer.appendChild(svgElement);
            }
            // Insert large robot avatar in chat sidebar on load as well
            const chatRobotAvatarLarge = document.getElementById('chat-robot-avatar-large');
            if (chatRobotAvatarLarge) {
                chatRobotAvatarLarge.innerHTML = ''; // Clear previous content
                const svgElement = createSvgElementFromString(robotSvgHtml);
                // Apply sizing and rounded-full directly to the SVG for the sidebar avatar
                svgElement.classList.add('w-48', 'h-48', 'rounded-full', 'shadow-lg'); // Removed bg-gray-200 and p-4
                chatRobotAvatarLarge.appendChild(svgElement);
            }
        });


        // --- Module Content Definition ---
        // This object holds all the text and button configurations for the "Tu Camino como Donante" module.
        const donorPathModule = {
            initial: {
                text: "¬°Qu√© decisi√≥n tan valiosa est√°s considerando! üíö\n\nAqu√≠ te acompa√±o paso a paso en tu camino como donante.\n\nEste recorrido te explicar√° lo esencial para tomar una decisi√≥n informada y compartirla con tus seres queridos.",
                buttons: [
                    { text: "Iniciar camino como donante üëâ", action: "donor_path_step1" }, 
                    { text: "Prefiero hacer una pregunta diferente", action: "reset_chat" }
                ]
            },
            step1: {
                // Modified for concision and general audience understanding
                text: "Para poder decidir, es importante que sepas qu√© significa donar. En M√©xico, se puede donar √≥rganos y tejidos despu√©s de fallecer, ya sea por Muerte encef√°lica (cuando el cerebro deja de funcionar por completo) o por Paro card√≠aco (cuando el coraz√≥n deja de latir y ya no se puede revivir). En ambos casos, la donaci√≥n puede salvar vidas o mejorar la salud de muchas personas.",
                buttons: [
                    { text: "S√≠, por favor", action: "donor_path_explain_muerte_encefalica" },
                    { text: "No, siguiente paso üëâ", action: "donor_path_step2" }
                ]
            },
            explain_muerte_encefalica: {
                // Modified for conciseness and general audience understanding
                text: "La muerte encef√°lica es cuando el cerebro, que controla todo el cuerpo, deja de funcionar de forma total e irreversible. Esto se confirma con pruebas m√©dicas rigurosas que demuestran que ya no hay actividad cerebral ni capacidad de respirar por s√≠ mismo. Es el momento en que una persona es legal y m√©dicamente declarada fallecida.",
                buttons: [
                    { text: "Entendido, siguiente paso üëâ", action: "donor_path_step2" }
                ]
            },
            step2: {
                // Modified for conciseness and general audience understanding
                text: "Donar es una decisi√≥n personal, libre y voluntaria. Te invito a pensar: ¬øMe gustar√≠a ayudar a alguien m√°s si ya no estoy aqu√≠? ¬øC√≥mo me sentir√≠a si alguien que amo necesitara un √≥rgano? No hay respuestas correctas. Lo importante es que lo pienses con el coraz√≥n. üíô",
                buttons: [
                    { text: "Estoy listo para el siguiente paso üëâ", action: "donor_path_step3" },
                    { text: "A√∫n tengo dudas", action: "indecision_start" } // Changed action to trigger indecision module
                ]
            },
            step3: {
                // Modified for concision and general audience understanding
                text: "Aunque t√∫ quieras donar, en M√©xico tu familia debe autorizarlo en el hospital. Por eso, lo m√°s importante es que hables con ellos y les digas tu deseo de donar. Puedes decir algo como: ‚ÄúSi alg√∫n d√≠a fallezco, quiero que donen mis √≥rganos. Es mi decisi√≥n.‚Äù",
                buttons: [
                    { text: "S√≠, mu√©strame ejemplos", action: "donor_path_examples_family_talk" },
                    { text: "Siguiente paso üëâ", action: "donor_path_step4" }
                ]
            },
            examples_family_talk: {
                // Modified for concision and general audience understanding
                text: "Aqu√≠ tienes algunas ideas para iniciar la conversaci√≥n con tu familia: ‚ÄúEstuve pensando en la donaci√≥n de √≥rganos y quiero compartirles mi decisi√≥n. Si algo me pasara, me gustar√≠a que mis √≥rganos ayudaran a alguien m√°s.‚Äù ‚ÄúEs un tema dif√≠cil, pero es importante para m√≠ que sepan que quiero ser donante. Es un acto de generosidad que siento que es correcto.‚Äù ‚ÄúInvestigu√© sobre la donaci√≥n de √≥rganos y me gustar√≠a dejar claro que es mi deseo. Me siento tranquilo con esta decisi√≥n.‚Äù",
                buttons: [
                    { text: "Entendido, siguiente paso üëâ", action: "donor_path_step4" }
                ]
            },
            step4: {
                // Modified for concision and general audience understanding
                text: "Adem√°s de hablar con tu familia, puedes dejar por escrito tu decisi√≥n de estas maneras: 1. Marc√°ndolo en tu INE (si renovaste y pediste que aparezca). 2. En el portal del Centro Nacional de Trasplantes (CENATRA): https://www.gob.gob.mx/cenatra 3. En una carta simple firmada. 4. O en tu testamento o voluntad anticipada (si aplica en tu estado).",
                buttons: [
                    { text: "S√≠, ens√©√±ame uno", action: "donor_path_example_carta" },
                    { text: "No, continuar üëâ", action: "donor_path_step5" }
                ]
            },
            example_carta: {
                text: "Aqu√≠ tienes un ejemplo de una carta simple de voluntad anticipada para donaci√≥n:\n\n\"[Tu Nombre Completo]\n[Tu Direcci√≥n]\n[Tu Ciudad, Estado, Fecha]\n\nA quien corresponda:\n\nPor medio de la presente, yo, [Tu Nombre Completo], con [Tipo de identificaci√≥n y n√∫mero, ej. INE 1234567890], declaro que, en caso de fallecimiento, es mi libre y voluntaria voluntad que mis √≥rganos y tejidos aptos sean donados para trasplante, con el fin de salvar o mejorar la calidad de vida de otras personas. Esta decisi√≥n es informada y definitiva. Solicito a mis familiares y al personal m√©dico respetar y facilitar este deseo.\n\nAtentamente,\n[Tu Firma]\n[Tu Nombre Completo]\n\nNota: Es recomendable tener testigos y/o notario, aunque una carta simple con tu firma es un inicio importante.\"",
                buttons: [
                    { text: "Entendido, continuar üëâ", action: "donor_path_step5" }
                ]
            },
            step5: {
                text: "Donar es un acto que vale repetir. Recu√©rdales a tus seres queridos tu decisi√≥n cada tanto. Puedes tambi√©n compartir tu voluntad en redes o por WhatsApp: ‚ÄúHe decidido que quiero donar mis √≥rganos si alg√∫n d√≠a muero. Es una forma de seguir ayudando. VIDA me ayud√≥ a informarme.‚Äù",
                buttons: [
                    { text: "Compartir por WhatsApp", action: "share_whatsapp", shareText: "He decidido que quiero donar mis √≥rganos si alg√∫n d√≠a muero. Es una forma de seguir ayudando. VIDA me ayud√≥ a informarme." },
                    { text: "Finalizar camino üíö", action: "donor_path_cierre" }
                ]
            },
            cierre: {
                text: "¬°Gracias por recorrer este camino conmigo! üå± Cada paso que das acerca a alguien m√°s a vivir con esperanza. Tu decisi√≥n es un acto de amor y generosidad.",
                buttons: [
                    { text: "Ver m√°s dudas frecuentes", action: "suggest_questions" }, 
                    { text: "Hablar con VIDA nuevamente", action: "reset_chat" }
                ]
            }
        };

        // Module: Empathetic Indecision Accompaniment
        const indecisionModule = {
            initial: {
                text: "Es completamente v√°lido tener dudas. La donaci√≥n es un tema profundo y personal. Muchas personas tambi√©n se sienten inseguras cuando empiezan a informarse. Estoy aqu√≠ para ayudarte a pensar en ello con calma.",
                buttons: [
                    { text: "Cu√©ntame por qu√© donar es valioso", action: "indecision_explain_impact" },
                    { text: "Prefiero hacer otra pregunta", action: "reset_chat" }
                ]
            },
            explain_impact: {
                text: "Donar √≥rganos despu√©s de fallecer puede transformar por completo la vida de varias personas. Con una sola decisi√≥n, puedes ayudar a que una madre vea crecer a sus hijos, o que un ni√±o recupere la salud.",
                buttons: [
                    { text: "¬øQu√© legado me gustar√≠a dejar?", action: "indecision_ask_reflection" },
                    { text: "Quiero saber c√≥mo hablar con mi familia", action: "donor_path_examples_family_talk" }, // Link to donor path module step 3
                    { text: "Prefiero hacer otra pregunta", action: "reset_chat" }
                ]
            },
            ask_reflection: {
                text: "¬øTe gustar√≠a que alguien ayudara a un ser querido tuyo si lo necesitara? ¬øHas pensado en qu√© legado te gustar√≠a dejar?",
                buttons: [
                    { text: "Quiero saber c√≥mo hablar con mi familia", action: "donor_path_examples_family_talk" },
                    { text: "Preg√∫ntame sobre la ley de donaci√≥n", action: "donor_path_step4" }, // Link to donor path step 4
                    { text: "Prefiero hacer otra pregunta", action: "reset_chat" }
                ]
            },
            // Cierre reinforcing autonomy and offering more paths
            cierre: {
                text: "Lo m√°s importante es que tomes una decisi√≥n con la informaci√≥n adecuada y en paz contigo mismo. Gracias por atreverte a pensar en esto. Est√°s dando un gran paso, sin importar tu elecci√≥n final.",
                buttons: [
                    { text: "Ver m√°s dudas frecuentes", action: "suggest_questions" }, // Reusing suggest_questions for generic suggestions
                    { text: "Iniciar camino como donante", action: "donor_path_initial" }, // Link to donor path initial
                    { text: "Hablar con VIDA nuevamente", action: "reset_chat" }
                ]
            }
        };

        const indecisionTriggers = [
            "no s√© si quiero donar", "tengo dudas sobre ser donante",
            "me da miedo donar", "no estoy seguro si quiero eso",
            "eso es muy fuerte", "nunca he pensado en eso",
            "no se si quiero donar", "tengo dudas sobre donar",
            "me da miedo", "no estoy seguro", "no quiero donar", "no quiero"
        ];

        // New Module: Empathetic Accompaniment for Grief/Anguish
        const griefModule = {
            initial: {
                // Paso 1: Contenci√≥n emocional inicial
                text: "Lamento profundamente tu p√©rdida. Entiendo que este es un momento de mucho dolor y confusi√≥n. Soy VIDA, y estoy aqu√≠ para brindarte informaci√≥n clara y respetuosa sobre la donaci√≥n de √≥rganos y tejidos, lo cual puede ser una opci√≥n de esperanza en momentos as√≠. S√© que es un tema delicado ahora, pero estoy aqu√≠ para explicarte todo lo que necesites saber al respecto.", 
                buttons: [
                    { text: "Comprendo, gracias", action: "grief_step2_validation" },
                    { text: "No quiero hablar de eso ahora", action: "grief_final_thanks" } 
                ]
            },
            step2_validation: {
                // Paso 2: Validaci√≥n emocional y permiso para seguir
                text: "Tus emociones son v√°lidas. Comprendo que este momento es abrumador. Mi prop√≥sito es ayudarte a entender c√≥mo la donaci√≥n puede ser un acto de generosidad que transforma vidas, si esto es algo que te interesa explorar ahora.", 
                buttons: [
                    { text: "Quiero entender la donaci√≥n", action: "grief_step3_intro" },
                    { text: "Prefiero hablar de otra cosa", action: "reset_chat" } // General reset, not a specialized grief reset
                ]
            },
            step3_intro: {
                // Paso 3: Introducci√≥n suave del tema de la donaci√≥n
                text: "En estos momentos dif√≠ciles, algunas familias encuentran consuelo al considerar la donaci√≥n de √≥rganos o tejidos. Es una forma de transformar el dolor en esperanza. Solo si lo deseas, puedo explicarte en qu√© consiste la donaci√≥n y c√≥mo puede ser un acto de amor y trascendencia.",
                buttons: [
                    { text: "S√≠, expl√≠came el valor de donar", action: "grief_step4_reflection" },
                    { text: "Prefiero hacer otra pregunta", action: "reset_chat" }
                ]
            },
            step4_reflection: {
                // Paso 4: Invitaci√≥n reflexiva a la donaci√≥n
                text: "La donaci√≥n puede ofrecer vida a otras personas y dar un sentido especial a la p√©rdida. Muchas familias dicen que eso les ayud√≥ en su duelo. Aceptar donar no borra el dolor, pero puede llenarlo de significado. Es una forma poderosa de que tu ser querido siga presente en el mundo. Cada decisi√≥n tomada con amor deja huella. Donar puede ser ese tipo de huella.",
                buttons: [
                    { text: "Entiendo, la decisi√≥n es m√≠a", action: "grief_step5_autonomy" },
                    { text: "Quiero saber m√°s sobre el proceso de donaci√≥n", action: "grief_process_overview" } // Direct to process overview
                ]
            },
            step5_autonomy: {
                // Paso 5: Respeto absoluto a la autonom√≠a
                text: "Estoy aqu√≠ para informarte y acompa√±arte. La decisi√≥n que tomes ser√° la correcta si la haces con el coraz√≥n. T√∫ tienes la libertad de decidir. Yo puedo ayudarte a entender, nunca a forzarte.",
                buttons: [
                    { text: "Ver m√°s dudas frecuentes", action: "suggest_questions" },
                    { text: "Iniciar Tu camino como donante", action: "donor_path_initial" },
                    { text: "Gracias, por ahora es suficiente", action: "grief_final_thanks" }
                ]
            },
            grief_process_overview: {
                text: "El proceso de donaci√≥n se hace con el m√°ximo respeto. Primero, se confirma el fallecimiento, luego se eval√∫a al donante y si es apto, se extraen los √≥rganos con cuidado. El cuerpo se restaura para el funeral. Todo ocurre r√°pidamente y con dignidad.",
                buttons: [
                    { text: "Mitos comunes sobre donaci√≥n (quiz)", action: "start_quiz" }, // Link to quiz
                    { text: "Necesito hablar con un experto", action: "grief_suggest_professional" },
                    { text: "Gracias, por ahora es suficiente", action: "grief_final_thanks" }
                ]
            },
            grief_suggest_professional: {
                text: "Si sientes que necesitas un apoyo m√°s profundo en este momento, considera hablar con un tanat√≥logo o psic√≥logo. Ellos pueden ofrecerte herramientas para manejar el duelo. Estoy aqu√≠ para cualquier otra pregunta que tengas sobre donaci√≥n.",
                buttons: [
                    { text: "Volver a preguntas de donaci√≥n", action: "suggest_questions" }, // General questions
                    { text: "Gracias, por ahora es suficiente", action: "grief_final_thanks" }
                ]
            },
            grief_final_thanks: {
                // Paso 6: Cierre con calidez, sin cortar el v√≠nculo, pero enfocando a la donaci√≥n.
                text: "Gracias por confiarme este momento. S√© que es un proceso doloroso y tu sentir es muy valioso. Si en alg√∫n futuro, cuando te sientas listo, deseas explorar m√°s sobre c√≥mo la donaci√≥n puede brindar esperanza, recuerda que aqu√≠ estar√© para informarte.",
                buttons: [
                    { text: "Ver m√°s dudas frecuentes", action: "suggest_questions" },
                    { text: "Hablar con VIDA nuevamente", action: "reset_chat" }
                ]
            }
        };

        const griefTriggers = [
            "mi mam√° acaba de morir", "mi hermano falleci√≥", "a mi mam√° la acaban de declarar con muerte cerebral",
            "no s√© si mi familiar quer√≠a donar", "me est√°n pidiendo autorizar la donaci√≥n y no s√© qu√© hacer",
            "estoy confundido con la donaci√≥n", "me da miedo la donaci√≥n", "estoy triste por la donaci√≥n",
            "no puedo con esto", "estoy abrumado", "mi ser querido muri√≥", "acaba de fallecer",
            "mi hermano fallecio", "a mi mama la acaban de declarar con muerte cerebral",
            "no se si mi familiar queria donar", "me estan pidiendo autorizar la donacion y no se que hacer",
            "mi hermano fallecio y me hablaron del hospital", "no estoy seguro de decir que si",
            "estoy confundido con la donacion", "me da miedo la donacion", "estoy triste por la donacion",
            "mi ser querido murio", "acaba de fallecer",
            "mi mama acaba de fallecer", "mi papa acaba de morir", "mi hijo fallecio", // More direct grief triggers
            "estoy devastado", "no se que hacer"
        ];

        // New Module: "Donaci√≥n de Familiar Fallecido"
        const familyDonationModule = {
            initial: {
                text: "Lamento mucho el momento que est√°s atravesando. Agradezco profundamente que, en medio del dolor, est√©s pensando en ayudar a otras personas.",
                buttons: [
                    { text: "Entendido, ¬øcu√°l es el siguiente paso?", action: "family_donation_step1" },
                    { text: "Necesito m√°s apoyo emocional", action: "grief_initial" }, // Link back to grief module if needed
                    { text: "Prefiero hacer otra pregunta", action: "reset_chat" }
                ]
            },
            step1: {
                text: "Para proceder con la donaci√≥n de √≥rganos de un ser querido, debes acudir lo antes posible al hospital p√∫blico m√°s cercano y pedir hablar con el Coordinador Hospitalario de Donaci√≥n. El Coordinador de Donaci√≥n es la persona capacitada para guiarte en este proceso, resolver tus dudas y brindarte acompa√±amiento con respeto y humanidad.",
                buttons: [
                    // Removed "Buscar hospital con coordinaci√≥n de donaci√≥n üëâ" as requested
                    { text: "Alternativa de contacto CENATRA", action: "family_donation_cenatra_contact" } // Renamed for clarity
                ]
            },
            cenatra_contact: {
                text: "Tambi√©n puedes comunicarte directamente con el Centro Nacional de Trasplantes (CENATRA) al tel√©fono 55 5062 1600, extensiones 57248, 57251 o 57252.",
                buttons: [
                    { text: "No estoy solo(a), ¬øqu√© m√°s puedo hacer?", action: "family_donation_cierre" }
                ]
            },
            cierre: {
                text: "No est√°s solo(a). Si necesitas m√°s informaci√≥n o hablar de lo que est√°s viviendo, estoy aqu√≠ para ti.",
                buttons: [
                    { text: "Ver m√°s dudas frecuentes", action: "suggest_questions" },
                    { text: "Hablar con VIDA nuevamente", action: "reset_chat" }
                ]
            }
        };

        const familyDonationTriggers = [
            "mi familiar falleci√≥ y quiero que sea donante",
            "queremos donar sus √≥rganos",
            "con qui√©n hablo para donar los √≥rganos de mi familiar",
            "mi familiar fallecio y quiero que sea donante",
            "queremos donar sus organos",
            "con quien hablo para donar los organos de mi familiar",
            "quiero donar los organos de mi familiar",
            "quiero donar los √≥rganos de mi familiar",
            "como donar los organos de mi familiar",
            "c√≥mo donar los √≥rganos de mi familiar",
            "autorizar donacion familiar",
            "autorizar donaci√≥n familiar",
            "mi papa murio y quiero donar", 
            "mi papa murio", 
            "mi mama murio y quiero donar", 
            "mi mama murio", 
            "mi hijo murio y quiero donar", 
            "mi hijo murio",
            "mi papa falleci√≥", 
            "mi mam√° muri√≥", 
            "mi hijo muri√≥", 
            "mi hermana falleci√≥", 
            "mi hermano falleci√≥", 
            "mis padres fallecieron", 
            "mi esposo falleci√≥", 
            "mi esposa falleci√≥", 
            "mi pareja falleci√≥", 
            "ser donante de mi familiar", 
            "autorizar donacion de mi familiar" ,
            "donaci√≥n en asistolia", 
            "donacion en asistolia", 
            "donaci√≥n por parada card√≠aca", 
            "donacion por parada cardiaca",
            "mi papa murio y quiero donar", // Specific check
            "mi papa fallecio y quiero donar" // Specific check
        ];


        // --- System Prompt ---
        // This system prompt guides the behavior of the chatbot, ensuring it stays within defined topics
        // and maintains an appropriate tone and helpfulness.
        // Enhanced for better comprehension and adherence to output style.
        const systemPrompt = `
        **DIRECTRICES PRINCIPALES PARA VIDA (ASISTENTE CONVERSACIONAL)**

        **Identidad y Prop√≥sito:**
        Eres "VIDA", un asistente virtual que ofrece orientaci√≥n confiable y respetuosa sobre la donaci√≥n de √≥rganos y tejidos despu√©s de que una persona ha fallecido en M√©xico (ya sea por muerte encef√°lica o cuando el coraz√≥n deja de latir). Tu rol es ser una herramienta de apoyo para decisiones informadas y humanas. Siempre responde como VIDA.

        **√Åmbito Tem√°tico (Permitido):**
        Solo responde a preguntas relacionadas con:
        - Qu√© es la muerte encef√°lica y su diagn√≥stico.
        - Qu√© es la donaci√≥n cuando el coraz√≥n ha dejado de latir y qu√© implica.
        - Criterios para confirmar que una persona ha fallecido (ya sea por muerte cerebral o cuando el coraz√≥n deja de latir).
        - Requisitos legales para donar √≥rganos o tejidos despu√©s de fallecer.
        - Qu√© √≥rganos o tejidos pueden recuperarse despu√©s de que una persona ha fallecido (ya sea por muerte cerebral o cuando el coraz√≥n deja de latir).
        - Cu√°nto tiempo hay para recuperar √≥rganos o tejidos despu√©s de que una persona ha fallecido.
        - Pasos que el personal de salud debe seguir para activar un proceso de donaci√≥n.
        - C√≥mo informar y acompa√±ar a la familia de la persona que podr√≠a ser donante.
        - Informaci√≥n relevante de las normas oficiales de salud en M√©xico (NOM-011-SSA3-2014) o el Centro Nacional de Trasplantes (CENATRA).

        **Temas Fuera de Alcance (No Permitidos):**
        Si una pregunta no est√° en el √°mbito permitido, responde **exactamente** con:
        "Lo siento, solo puedo ayudarte con preguntas sobre donaci√≥n de √≥rganos y tejidos despu√©s de que una persona ha fallecido (muerte encef√°lica o cuando el coraz√≥n deja de latir)."
        Esto incluye: diagn√≥sticos m√©dicos no relacionados, casos personales espec√≠ficos, tr√°mites hospitalarios individuales, opiniones religiosas/pol√≠ticas/√©ticas que no est√©n en el marco normativo, temas legales no cubiertos por normas de salud.

        **Comportamiento y Tono (Crucial):**
        - **Lenguaje Claro y Accesible:** S√© concreto, conciso y f√°cil de entender para el p√∫blico general. Evita cualquier tipo de jerga m√©dica. Si por alguna raz√≥n se necesita un t√©rmino cl√≠nico, expl√≠calo inmediatamente con palabras sencillas y cotidianas. No uses asteriscos (*) ni vi√±etas. Puedes usar p√°rrafos cortos o listas numeradas (1. 2. 3. o guiones -) para organizar la informaci√≥n.
        - **Respuestas Concisas y Elaboraci√≥n Opcional:** Tus respuestas iniciales deben ser directas y al punto. Si el usuario pide "m√°s informaci√≥n", "detalles" o "quiero saber m√°s", puedes expandir la explicaci√≥n de manera clara.
        - **Coherencia Conversacional y Comprensi√≥n del Contexto:**
            - Siempre recuerda y respeta el hilo de la conversaci√≥n. Considera el contexto de lo que el usuario ha mencionado antes, especialmente en temas emocionales, decisiones familiares o seguimiento de dudas.
            - Al responder, inicia reconociendo el tema previo para mantener la fluidez (ej. "Gracias por retomar el tema sobre...", "Entiendo que seguimos hablando del caso de tu familiar...", "Retomando lo que me comentaste sobre la muerte encef√°lica...").
            - Responde directamente a lo ya mencionado, sin cambiar de tema abruptamente ni repetir informaci√≥n.
            - En temas sensibles, refuerza la continuidad emocional: "S√© que esta situaci√≥n no es f√°cil, y agradezco que sigas compartiendo conmigo. Estoy contigo paso a paso, retomando cada parte seg√∫n lo que vayas necesitando."
            - Si no comprendes el contexto con claridad o la pregunta es ambigua, pide aclaraci√≥n amablemente: "¬øPodr√≠as contarme un poco m√°s para darte la mejor respuesta? Por ejemplo, ¬øte refieres a la donaci√≥n de √≥rganos o a otro tema relacionado con tu familiar?"
        - **Evita Respuestas Cerradas o Limitadas:** Nunca digas "no puedo ayudarte" o "no entiendo". Siempre reorienta la conversaci√≥n con calidez hacia lo que s√≠ puedes explicar: "Ese tema no lo tengo disponible, pero s√≠ puedo ayudarte a entender c√≥mo es el proceso de donaci√≥n de √≥rganos y tejidos despu√©s de que una persona ha fallecido. ¬øTe interesa saber c√≥mo se confirma la muerte cerebral?"
        - **Confirmar Temas Delicados:** Antes de responder preguntas sensibles o amplias, confirma la intenci√≥n: ‚ÄúSolo para responderte bien: ¬øquieres saber qu√© √≥rganos se pueden donar despu√©s de que una persona ha fallecido?‚Äù o ‚Äú¬øEst√°s preguntando desde el punto de vista de un familiar o como personal de salud?‚Äù
        - **Donaci√≥n = Despu√©s de fallecer (Contexto Principal):** Cuando el usuario pregunte "Quiero donar" o "C√≥mo dono", asume por defecto que se refiere a donaci√≥n de √≥rganos y tejidos despu√©s de que una persona ha fallecido. Responde: "Gracias por tu inter√©s. Esta app est√° centrada en la donaci√≥n de √≥rganos y tejidos despu√©s de que una persona ha fallecido. ¬øQuieres saber c√≥mo puedes manifestar tu voluntad como donante?"
        - **Priorizaci√≥n del Bienestar Emocional (Modo Tanatol√≥gico Suave):**
            - Si el usuario expresa angustia, p√©rdida reciente, confusi√≥n o miedo (ej. "Mi mam√° acaba de morir", "estoy devastado", "no s√© qu√© hacer"), suspende explicaciones t√©cnicas.
            - Primero ofrece contenci√≥n emocional b√°sica: "Lamento profundamente tu p√©rdida. Entiendo que este es un momento de mucho dolor y confusi√≥n. Soy VIDA, y estoy aqu√≠ para brindarte informaci√≥n clara y respetuosa sobre la donaci√≥n de √≥rganos y tejidos, lo cual puede ser una opci√≥n de esperanza en momentos as√≠. Estoy aqu√≠ para explicarte todo lo que necesites saber al respecto."
            - Valida sus emociones: "Tus emociones son v√°lidas. Comprendo que este momento es abrumador. Mi prop√≥sito es ayudarte a entender c√≥mo la donaci√≥n puede ser un acto de generosidad que transforma vidas, si esto es algo que te interesa explorar ahora."
            - Ofrece informaci√≥n solo si el usuario da permiso, sin presionar: "Si en alg√∫n momento deseas saber m√°s sobre qu√© significa donar, puedo explic√°rtelo."
            - Sugiere profesionales: "Si sientes que necesitas un apoyo m√°s profundo, considera hablar con un tanat√≥logo o psic√≥logo. Ellos pueden ofrecerte herramientas valiosas en este camino."
            - Cierra con humanidad, enfocando sutilmente a la donaci√≥n: "Gracias por confiarme este momento. S√© que es un proceso doloroso y tu sentir es muy valioso. Si en alg√∫n futuro, cuando te sientas listo, deseas explorar m√°s sobre c√≥mo la donaci√≥n puede brindar esperanza, recuerda que aqu√≠ estar√© para informarte."

        **Fomento de la Cultura de Donaci√≥n:**
        - Refuerza el valor social y humano de la donaci√≥n sin imponerla: "Donar √≥rganos despu√©s de fallecer es un acto de generosidad. En M√©xico, miles de personas esperan una segunda oportunidad gracias a una donaci√≥n. Pensar en esto ya es un primer paso."
        - Muestra el impacto positivo (cifras reales si se piden). Nunca juzgues a quien no decide donar.
        - Finalizaciones Humanas: Al cerrar, desp√≠dete con gratitud y disposici√≥n a acompa√±ar m√°s tarde.
        `;

        // --- UI Functions ---
        // Shows the chat screen with a fade-in effect.
        const showChat = () => {
            welcomeScreen.style.display = 'none'; // Hide welcome screen
            chatScreen.style.display = 'flex';
            setTimeout(() => chatScreen.classList.add('opacity-100'), 50); 
        };
        
        // Hides the chat screen with a fade-out effect.
        const hideChat = () => {
            chatScreen.classList.remove('opacity-100');
            // Hide suggested questions and clear them when closing chat
            suggestedQuestionsContainer.classList.add('hidden');
            suggestedQuestionsContainer.innerHTML = '';
            currentDonorPathStep = null; // Reset donor path when closing chat
            currentQuizQuestionIndex = -1; // Reset quiz state
            quizQuestions = []; // Clear quiz questions
            currentIndecisionStep = null; // Reset indecision state
            currentGriefStep = null; // Reset grief state
            currentFamilyDonationStep = null; // Reset family donation state
            setTimeout(() => { chatScreen.style.display = 'none'; welcomeScreen.style.display = 'flex'; }, 300); // Show welcome screen
        };
        
        // Generic function to open a modal.
        const openModal = (modal) => modal.style.display = 'flex';
        // Generic function to close a modal.
        const closeModal = (modal) => modal.style.display = 'none';

        // --- Event Listeners ---
        // When "Iniciar conversaci√≥n" is clicked, it only shows the chat and initial greeting.
        startChatBtn.addEventListener('click', () => {
            showChat(); // First, transition to the chat screen
            // Reset chat state for a fresh start
            chatHistory = []; 
            chatContainer.innerHTML = ''; 
            currentDonorPathStep = null; // Ensure no module is active
            currentQuizQuestionIndex = -1; // Ensure no quiz is active
            quizQuestions = [];
            currentIndecisionStep = null; // Ensure no indecision module is active
            currentGriefStep = null; // Ensure no grief module is active
            currentFamilyDonationStep = null; // Ensure no family donation module is active
            addInitialBotMessage(); // Add the initial greeting
        });

        // Event listener for the new "Desmitificador Express" button on welcome screen
        startQuizBtn.addEventListener('click', () => {
            showChat(); // Transition to the chat screen
            chatHistory = []; // Clear chat history
            chatContainer.innerHTML = ''; // Clear chat display
            currentDonorPathStep = null; // Ensure no donor path module is active
            currentIndecisionStep = null; // Ensure no indecision module is active
            currentGriefStep = null; // Ensure no grief module is active
            currentFamilyDonationStep = null; // Ensure no family donation module is active
            startQuiz(); // Start the quiz module
        });

        closeChatBtn.addEventListener('click', hideChat);
        
        // Event listeners for the 'About' modal
        aboutBtn.addEventListener('click', () => openModal(aboutModal));
        closeModalBtn.addEventListener('click', () => closeModal(aboutModal));
        // Close modal if user clicks outside the modal content
        aboutModal.addEventListener('click', (e) => {
            if (e.target === aboutModal) closeModal(aboutModal);
        });
        
        // Event listeners for the 'Feedback' modal
        feedbackBtn.addEventListener('click', () => openModal(feedbackModal));
        closeFeedbackModalBtn.addEventListener('click', () => closeModal(feedbackModal));
        // Close modal if user clicks outside the modal content
        feedbackModal.addEventListener('click', (e) => {
             if (e.target === feedbackModal) closeModal(feedbackModal);
        });

        // Handles the submission of the feedback form.
        feedbackForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const scriptURL = 'REEMPLAZA_CON_LA_URL_DE_TU_SCRIPT'; // <-- IMPORTANT: Replace this with your Google Apps Script URL
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true; // Disable button to prevent multiple submissions
            submitButton.textContent = 'Enviando...'; // Update button text

            fetch(scriptURL, { method: 'POST', body: new FormData(form)})
                .then(response => {
                    console.log('Success!', response);
                    feedbackFormContainer.style.display = 'none'; // Hide form
                    feedbackThanks.style.display = 'block'; // Show thank you message
                    // Reset form and hide thank you message after a delay
                    setTimeout(() => {
                        closeModal(feedbackModal);
                        feedbackFormContainer.style.display = 'block';
                        feedbackThanks.style.display = 'none';
                        form.reset(); // Clear form fields
                        submitButton.disabled = false; // Re-enable button
                        submitButton.textContent = 'Enviar respuesta'; // Reset button text
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error!', error.message);
                    // Use a custom message box instead of alert() for better UX
                    addMessageToChat('bot', "Error al enviar la encuesta. Por favor, intenta de nuevo."); 
                    submitButton.disabled = false;
                    submitButton.textContent = 'Enviar respuesta';
                });
        });

        // --- Module Functions (Defined before chatForm.addEventListener for proper scope) ---

        // Function to reset chat state and potentially offer general questions
        function reset_chat_and_offer_suggestions() {
            chatHistory = [];
            suggestedQuestionsContainer.classList.add('hidden');
            suggestedQuestionsContainer.innerHTML = '';
            chatContainer.innerHTML = '';
            currentDonorPathStep = null;
            currentIndecisionStep = null;
            currentGriefStep = null;
            currentFamilyDonationStep = null; // Reset family donation state
            addInitialBotMessage(); // This will add the default welcome message
        }

        // Indecision Module Functions
        function displayIndecisionStep(stepKey) {
            const stepContent = indecisionModule[stepKey];
            if (!stepContent) {
                console.error("Invalid indecision step:", stepKey);
                addMessageToChat('bot', "Lo siento, hubo un problema al cargar la informaci√≥n sobre tu duda. Por favor, intenta de nuevo.");
                currentIndecisionStep = null; // Reset
                return;
            }

            addMessageToChat('bot', stepContent.text);

            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden');

            if (stepContent.buttons && stepContent.buttons.length > 0) {
                stepContent.buttons.forEach(buttonData => {
                    const button = document.createElement('button');
                    button.textContent = buttonData.text;
                    button.className = `px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium 
                                        hover:bg-[var(--vida-module-btn-hover)] transition-colors shadow-sm whitespace-nowrap overflow-hidden text-ellipsis`;
                    button.onclick = () => {
                        handleIndecisionAction(buttonData.action, buttonData);
                    };
                    suggestedQuestionsContainer.appendChild(button);
                });
            }
        }

        async function handleIndecisionAction(action, buttonData = {}) {
            addMessageToChat('user', buttonData.text || action);

            if (action.startsWith('indecision_')) {
                currentIndecisionStep = action.replace('indecision_', '');
                displayIndecisionStep(currentIndecisionStep);
            } else if (action.startsWith('donor_path_')) {
                currentIndecisionStep = null; // Exit indecision module
                currentDonorPathStep = action.replace('donor_path_', '');
                displayDonorPathStep(currentDonorPathStep);
            } else if (action === 'reset_chat') {
                reset_chat_and_offer_suggestions(); // Use the general reset function
            } else if (action === 'suggest_questions') {
                currentIndecisionStep = null; // Exit indecision module
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                await generateSuggestedQuestions();
            }
        }
        
        // Grief Module Functions
        function displayGriefStep(stepKey) {
            const stepContent = griefModule[stepKey];
            if (!stepContent) {
                console.error("Invalid grief step:", stepKey);
                addMessageToChat('bot', "Lo siento, hubo un problema al cargar la informaci√≥n. Por favor, intenta de nuevo.");
                currentGriefStep = null; // Reset
                return;
            }

            addMessageToChat('bot', stepContent.text);
            
            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden');

            if (stepContent.buttons && stepContent.buttons.length > 0) {
                stepContent.buttons.forEach(buttonData => {
                    const button = document.createElement('button');
                    button.textContent = buttonData.text;
                    button.className = `px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium 
                                        hover:bg-[var(--vida-module-btn-hover)] transition-colors shadow-sm whitespace-nowrap overflow-hidden text-ellipsis`;
                    button.onclick = () => {
                        handleGriefAction(buttonData.action, buttonData);
                    };
                    suggestedQuestionsContainer.appendChild(button);
                });
            }
        }

        async function handleGriefAction(action, buttonData = {}) {
            addMessageToChat('user', buttonData.text || action);

            if (action.startsWith('grief_')) {
                currentGriefStep = action.replace('grief_', '');
                displayGriefStep(currentGriefStep);
            } else if (action.startsWith('donor_path_')) {
                currentGriefStep = null; // Exit grief module
                currentDonorPathStep = action.replace('donor_path_', '');
                displayDonorPathStep(currentDonorPathStep);
            } else if (action === 'start_quiz') { // Allow starting quiz from grief module
                currentGriefStep = null; // Exit grief module
                startQuiz();
            } else if (action === 'suggest_questions') {
                currentGriefStep = null; // Exit grief module
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                await generateSuggestedQuestions();
            } else if (action === 'reset_chat' || action === 'reset_chat_after_grief') { // Handle specific reset for grief
                reset_chat_and_offer_suggestions(); // Use the general reset function
            }
        }

        // Family Donation Module Functions
        function displayFamilyDonationStep(stepKey) {
            const stepContent = familyDonationModule[stepKey];
            if (!stepContent) {
                console.error("Invalid family donation step:", stepKey);
                addMessageToChat('bot', "Lo siento, hubo un problema al cargar la informaci√≥n. Por favor, intenta de nuevo.");
                currentFamilyDonationStep = null; // Reset
                return;
            }

            addMessageToChat('bot', stepContent.text);
            
            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden');

            if (stepContent.buttons && stepContent.buttons.length > 0) {
                stepContent.buttons.forEach(buttonData => {
                    const button = document.createElement('button');
                    button.textContent = buttonData.text;
                    button.className = `px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium 
                                        hover:bg-[var(--vida-module-btn-hover)] transition-colors shadow-sm whitespace-nowrap overflow-hidden text-ellipsis`;
                    button.onclick = () => {
                        handleFamilyDonationAction(buttonData.action, buttonData);
                    };
                    suggestedQuestionsContainer.appendChild(button);
                });
            }
        }

        async function handleFamilyDonationAction(action, buttonData = {}) {
            addMessageToChat('user', buttonData.text || action);

            if (action.startsWith('family_donation_')) {
                currentFamilyDonationStep = action.replace('family_donation_', '');
                displayFamilyDonationStep(currentFamilyDonationStep);
            } else if (action === 'open_cenatra_link') {
                if (buttonData.link) {
                    window.open(buttonData.link, '_blank');
                    addMessageToChat('bot', 'Se abri√≥ la p√°gina de CENATRA en una nueva pesta√±a.');
                }
                currentFamilyDonationStep = null; // Exit module after opening link
                reset_chat_and_offer_suggestions(); // Use the general reset function to go back to initial state
            } else if (action === 'grief_initial') { // Link to general grief module
                currentFamilyDonationStep = null;
                currentGriefStep = 'initial';
                displayGriefStep(currentGriefStep);
            } else if (action === 'reset_chat') {
                reset_chat_and_offer_suggestions(); // Use the general reset function
            } else if (action === 'suggest_questions') {
                currentFamilyDonationStep = null;
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                await generateSuggestedQuestions();
            }
        }


        // Handles the submission of the chat form.
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = chatInput.value.trim();
            if (!userMessage) return; // Don't send empty messages

            // Priority 1: If a quiz is active, handle the quiz action
            if (currentQuizQuestionIndex !== -1) {
                addMessageToChat('user', userMessage); // Show user's typed message
                chatInput.value = ''; // Clear input
                addMessageToChat('bot', "Por favor, usa los botones para interactuar con el quiz.");
                return; // Stop further processing
            }

            // Priority 2: If a family donation module is active, handle its actions (buttons only)
            if (currentFamilyDonationStep) {
                // User typing directly while in family donation module: treat as "ask another question" and exit module
                addMessageToChat('user', userMessage);
                chatInput.value = '';
                currentFamilyDonationStep = null; // Exit family donation module
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                addMessageToChat('bot', "Comprendo. Si tienes otra pregunta sobre donaci√≥n de √≥rganos y tejidos, no dudes en escribirla.");
                await getBotResponse(userMessage);
                return;
            }

            // Priority 3: Check for family donation triggers (to start the module)
            if (familyDonationTriggers.some(trigger => userMessage.toLowerCase().includes(trigger))) {
                addMessageToChat('user', userMessage);
                chatInput.value = '';
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                currentFamilyDonationStep = 'initial';
                displayFamilyDonationStep(currentFamilyDonationStep);
                return;
            }

            // Priority 4: If a grief module is active, handle its actions (buttons only)
            if (currentGriefStep) {
                 // If user types while in grief module, treat as "ask another question" and exit grief module
                addMessageToChat('user', userMessage); // Show user's typed message
                chatInput.value = ''; // Clear input
                currentGriefStep = null; // Exit grief module
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                addMessageToChat('bot', "Comprendo. Si tienes otra pregunta sobre donaci√≥n de √≥rganos y tejidos, no dudes en escribirla.");
                await getBotResponse(userMessage); // Get a general bot response for their typed question
                return;
            }

            // Priority 5: Check for grief triggers (to start the module)
            if (griefTriggers.some(trigger => userMessage.toLowerCase().includes(trigger))) {
                addMessageToChat('user', userMessage);
                chatInput.value = '';
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                currentGriefStep = 'initial';
                displayGriefStep(currentGriefStep);
                return;
            }

            // Priority 6: If an indecision module is active, handle its actions (buttons only)
            if (currentIndecisionStep) {
                // User typing directly while in indecision module: treat as "ask another question"
                addMessageToChat('user', userMessage); // Show user's typed message
                chatInput.value = ''; // Clear input
                currentIndecisionStep = null; // Exit indecision module
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                addMessageToChat('bot', "Comprendo. Si tienes otra pregunta sobre donaci√≥n de √≥rganos y tejidos, no dudes en escribirla.");
                await getBotResponse(userMessage); // Get a general bot response for their typed question
                return;
            }

            // Priority 7: Check for indecision triggers (to start the module)
            if (indecisionTriggers.some(trigger => userMessage.toLowerCase().includes(trigger))) {
                addMessageToChat('user', userMessage);
                chatInput.value = '';
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                currentIndecisionStep = 'initial';
                displayIndecisionStep(currentIndecisionStep);
                return;
            }
            
            // Priority 8: Trigger phrases for "Tu Camino como Donante" module
            const donorPathTriggers = [
                "quiero donar", "como dono", "quiero ser donante", "quiero ayudar", "donar mis organos",
                "quiero donar", "c√≥mo dono", "quiero ser donante", "quiero ayudar", "donar mis √≥rganos" // Include accented versions
            ];

            // If user input matches a module trigger, start the module
            if (donorPathTriggers.some(trigger => userMessage.toLowerCase().includes(trigger))) { // Used .some() here for triggers
                addMessageToChat('user', userMessage); // Add user's trigger message
                chatInput.value = ''; // Clear input
                suggestedQuestionsContainer.classList.add('hidden'); // Hide suggestions
                suggestedQuestionsContainer.innerHTML = ''; 
                currentDonorPathStep = 'initial'; // Set the initial step
                displayDonorPathStep(currentDonorPathStep); // Display the initial module loop
                return; // Stop further processing as module is taking over
            }

            // Priority 9: If a donor path module is active, handle its action (buttons only)
            if (currentDonorPathStep) {
                // This block should only be hit if a button was clicked.
                handleDonorPathAction(userMessage); 
                chatInput.value = ''; 
                return; 
            }

            // Priority 10: Default to general bot response
            addMessageToChat('user', userMessage);
            chatInput.value = ''; 
            suggestedQuestionsContainer.classList.add('hidden'); 
            suggestedQuestionsContainer.innerHTML = ''; 
            await getBotResponse(userMessage); 
        });

        // Event listener for the "Suggest Questions" button
        suggestQuestionsBtn.addEventListener('click', async () => {
            // Reset any active module if "Sugiere preguntas" is clicked
            if (currentDonorPathStep || currentQuizQuestionIndex !== -1 || currentIndecisionStep || currentGriefStep || currentFamilyDonationStep) {
                currentDonorPathStep = null;
                currentQuizQuestionIndex = -1;
                quizQuestions = [];
                currentIndecisionStep = null;
                currentGriefStep = null;
                currentFamilyDonationStep = null;
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
            }
            await generateSuggestedQuestions();
        });
        
        // --- Chat Functions ---
        // Adds the initial welcome message from the bot to the chat.
        function addInitialBotMessage() {
            // Only add initial message if chat history is empty
            if (chatHistory.length === 0) {
                const initialMessage = "Hola, soy VIDA. Estoy aqu√≠ para ofrecerte respuestas claras y basadas en protocolos oficiales sobre la donaci√≥n de √≥rganos y tejidos. ¬øEn qu√© puedo ayudarte hoy?";
                addMessageToChat('bot', initialMessage);
            }
        }
        
        // Adds a message to the chat display.
        function addMessageToChat(sender, text) {
            const messageWrapper = document.createElement('div');
            // Dynamically set classes based on sender for alignment and styling
            messageWrapper.className = `flex items-end gap-2 max-w-lg lg:max-w-xl ${sender === 'user' ? 'self-end' : 'self-start'}`;
            
            // Replace newlines with <br> for proper HTML rendering
            const textContent = text.replace(/\n/g, '<br>');

            if (sender === 'user') {
                // User message bubble styling
                messageWrapper.innerHTML = `<div class="order-1 bg-[var(--vida-chat-user-bg)] text-slate-800 rounded-2xl rounded-br-none px-4 py-3 shadow-sm chat-bubble-text">${textContent}</div>`;
            } else {
                // Bot message bubble styling with a small SVG robot avatar
                const botAvatarDiv = document.createElement('div');
                botAvatarDiv.className = "w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 message-robot-avatar overflow-hidden";
                // Append the SVG created from the string
                botAvatarDiv.appendChild(createSvgElementFromString(robotSvgHtml));

                const textBubbleDiv = document.createElement('div');
                textBubbleDiv.className = "bg-[var(--vida-chat-bot-bg)] text-slate-800 rounded-2xl rounded-bl-none px-4 py-3 shadow-sm chat-bubble-text";
                textBubbleDiv.innerHTML = textContent;

                messageWrapper.appendChild(botAvatarDiv);
                messageWrapper.appendChild(textBubbleDiv);
            }
            
            chatContainer.appendChild(messageWrapper);
            // Scroll to the bottom of the chat to show the latest message
            chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
        }

        // Toggles the visibility of the typing indicator for the bot.
        function showTypingIndicator(show) {
            let typingIndicator = document.getElementById('typing-indicator');
            if (show) {
                if (!typingIndicator) {
                    typingIndicator = document.createElement('div');
                    typingIndicator.id = 'typing-indicator';
                    typingIndicator.className = 'flex items-end gap-2 self-start typing-indicator-robot'; /* Added class for specific animation */
                    
                    const robotAvatarDiv = document.createElement('div');
                    robotAvatarDiv.className = "w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 typing-indicator-robot overflow-hidden";
                    // Append the SVG created from the string
                    robotAvatarDiv.appendChild(createSvgElementFromString(robotSvgHtml));

                    const typingDotsDiv = document.createElement('div');
                    typingDotsDiv.className = "bg-[var(--vida-chat-bot-bg)] text-slate-800 rounded-2xl rounded-bl-none px-4 py-3 shadow-sm";
                    typingDotsDiv.innerHTML = `
                        <div class="flex items-center space-x-1.5">
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: -0.3s;"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: -0.15s;"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
                        </div>`;

                    typingIndicator.appendChild(robotAvatarDiv);
                    typingIndicator.appendChild(typingDotsDiv);
                    chatContainer.appendChild(typingIndicator);
                    chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
                }
            } else {
                if (typingIndicator) typingIndicator.remove();
            }
        }
        
        // Fetches a response from the Gemini API based on the user's prompt (for general questions).
        async function getBotResponse(prompt) {
            showTypingIndicator(true); 
            chatInput.disabled = true; 
            chatForm.querySelector('button[type="submit"]').disabled = true; 
            suggestQuestionsBtn.disabled = true; 

            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);

                const result = await response.json();
                
                let botResponseText = "Lo siento, hubo un problema al procesar tu solicitud. Por favor, intenta de nuevo.";

                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    botResponseText = result.candidates[0].content.parts[0].text;
                }
                
                chatHistory.push({ role: "model", parts: [{ text: botResponseText }] });
                showTypingIndicator(false); 
                addMessageToChat('bot', botResponseText);

            } catch (error) {
                console.error("Error fetching bot response:", error);
                addMessageToChat('bot', 'Hubo un problema de conexi√≥n. Por favor, verifica tu conexi√≥n e int√©ntalo de nuevo.');
            } finally {
                chatInput.disabled = false;
                chatForm.querySelector('button[type="submit"]').disabled = false;
                suggestQuestionsBtn.disabled = false;
                chatInput.focus();
            }
        }

        // Generates suggested questions from the Gemini API.
        async function generateSuggestedQuestions() {
            suggestQuestionsBtn.disabled = true;
            suggestButtonText.textContent = 'Generando...'; 
            suggestedQuestionsContainer.innerHTML = ''; 
            suggestedQuestionsContainer.classList.add('hidden'); 

            const questionGenerationPrompt = `
                Act√∫a como VIDA, un asistente de donaci√≥n de √≥rganos en M√©xico.
                Genera 3 preguntas cortas y sencillas que un familiar o p√∫blico general podr√≠a hacer sobre la donaci√≥n de √≥rganos y tejidos en el contexto de muerte encef√°lica o parada card√≠aca en M√©xico.
                Las preguntas deben ser muy concisas y directas.
                Devuelve la respuesta como un array JSON de 3 strings, donde cada string es una pregunta.
            `;

            const payload = {
                contents: [{ role: "user", parts: [{ text: questionGenerationPrompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: { "type": "STRING" },
                        minItems: 3,
                        maxItems: 3
                    }
                }
            };

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);

                const result = await response.json();
                
                let suggestedQuestions = [];
                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    try {
                        suggestedQuestions = JSON.parse(result.candidates[0].content.parts[0].text);
                    } catch (e) {
                        console.error("Error parsing suggested questions JSON:", e);
                        addMessageToChat('bot', 'No pude generar sugerencias de preguntas. Intenta de nuevo.');
                        return;
                    }
                }
                
                displaySuggestedQuestions(suggestedQuestions);

            } catch (error) {
                console.error("Error generating suggested questions:", error);
                addMessageToChat('bot', 'Hubo un problema al obtener sugerencias. Por favor, intenta de nuevo.');
            } finally {
                suggestQuestionsBtn.disabled = false;
                suggestButtonText.textContent = 'Sugiere'; 
            }
        }

        // Displays the suggested questions as clickable buttons.
        function displaySuggestedQuestions(questions) {
            suggestedQuestionsContainer.innerHTML = ''; 
            if (questions && questions.length > 0) {
                questions.forEach(question => {
                    const button = document.createElement('button');
                    button.textContent = question;
                    button.className = `px-3 py-1.5 rounded-full bg-[var(--vida-suggest-btn-bg)] text-[var(--vida-text-dark)] text-sm font-medium 
                                        hover:bg-[var(--vida-suggest-btn-hover)] transition-colors shadow-sm whitespace-nowrap overflow-hidden text-ellipsis`;
                    button.onclick = () => {
                        chatInput.value = question; 
                        chatForm.requestSubmit(); 
                        suggestedQuestionsContainer.classList.add('hidden'); 
                        suggestedQuestionsContainer.innerHTML = ''; 
                    };
                    suggestedQuestionsContainer.appendChild(button);
                });
                suggestedQuestionsContainer.classList.remove('hidden'); 
            } else {
                suggestedQuestionsContainer.classList.add('hidden'); 
            }
        }

        // --- "Tu Camino como Donante" Module Functions ---
        // Displays the content and buttons for a specific step of the donor path module.
        function displayDonorPathStep(stepKey) {
            const stepContent = donorPathModule[stepKey];
            if (!stepContent) {
                console.error("Invalid donor path step:", stepKey);
                addMessageToChat('bot', "Lo siento, hubo un problema al cargar la informaci√≥n. Por favor, intenta iniciar el camino de nuevo.");
                currentDonorPathStep = null; // Reset
                return;
            }

            addMessageToChat('bot', stepContent.text); // Display bot's message for the step
            
            // Clear and hide existing suggested questions/buttons
            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden'); // Ensure container is visible for module buttons

            // Create and append buttons for the current step
            if (stepContent.buttons && stepContent.buttons.length > 0) {
                stepContent.buttons.forEach(buttonData => {
                    const button = document.createElement('button');
                    button.textContent = buttonData.text;
                    button.className = `px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium 
                                        hover:bg-[var(--vida-module-btn-hover)] transition-colors shadow-sm whitespace-nowrap overflow-hidden text-ellipsis`;
                    // Assign a direct action to the button click for easier handling in handleDonorPathAction
                    button.onclick = () => {
                        handleDonorPathAction(buttonData.action, buttonData); // Pass action and full data
                    };
                    suggestedQuestionsContainer.appendChild(button);
                });
            }
        }

        // Handles actions triggered by buttons within the "Tu Camino como Donante" module.
        async function handleDonorPathAction(action, buttonData = {}) { // Accept buttonData
            // Add the "clicked button text" as a user message for context in chat history
            // Find the button text from the current step's buttons based on the action
            // (This is now passed directly as buttonData.text when button is clicked)
            addMessageToChat('user', buttonData.text || action); // Use buttonData.text if available

            // Logic based on the action
            if (action.startsWith('donor_path_')) {
                // Navigate to the next step in the module
                currentDonorPathStep = action.replace('donor_path_', ''); // e.g., 'donor_path_step1' -> 'step1'
                displayDonorPathStep(currentDonorPathStep);
            } else if (action === 'share_whatsapp') {
                if (buttonData.shareText) { // Use shareText from buttonData
                    const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(buttonData.shareText)}`;
                    window.open(whatsappUrl, '_blank');
                    addMessageToChat('bot', '¬°Mensaje de WhatsApp preparado! Comp√°rtelo para difundir la informaci√≥n.');
                }
                currentDonorPathStep = null; // Exit module after share
                addInitialBotMessage(); // Or just give a concluding message
            } else if (action === 'suggest_questions') {
                currentDonorPathStep = null; // Exit module
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                await generateSuggestedQuestions();
            } else if (action === 'reset_chat') {
                currentDonorPathStep = null; // Exit module
                chatHistory = []; // Clear chat history
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                chatContainer.innerHTML = ''; // Clear chat display
                addInitialBotMessage(); // Add initial bot message
            } else if (action === 'ask_about_donation_doubts') {
                currentDonorPathStep = null; // Exit module, allow general chat
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                // We'll simulate user typing this into the input and submitting.
                chatInput.value = "Tengo dudas sobre la donaci√≥n."; // Example general query
                chatForm.requestSubmit(); // Submit the form to trigger normal chat flow
            } else if (action === 'indecision_start') { // Handle indecision_start directly from donor path
                currentDonorPathStep = null;
                currentIndecisionStep = 'initial';
                displayIndecisionStep(currentIndecisionStep);
            }
        }

        // --- "Desmitificador Express" Quiz Module Functions ---
        // Starts the quiz module
        async function startQuiz() {
            currentQuizQuestionIndex = -1; // Reset index
            quizQuestions = []; // Clear previous questions
            currentDonorPathStep = null; // Ensure donor path is reset
            currentIndecisionStep = null; // Ensure indecision module is reset
            currentGriefStep = null; // Ensure grief module is reset
            currentFamilyDonationStep = null; // Ensure family donation module is reset

            addMessageToChat('bot', "¬°Vamos a poner a prueba tus conocimientos! Te har√© 10 preguntas de verdadero o falso sobre la donaci√≥n de √≥rganos y tejidos. Cada respuesta te dir√° si acertaste y por qu√©. ¬øListo?");
            
            suggestedQuestionsContainer.innerHTML = ''; // Clear any existing buttons
            suggestedQuestionsContainer.classList.remove('hidden'); // Ensure container is visible

            const startButton = document.createElement('button');
            startButton.textContent = "S√≠, empezar el juego";
            startButton.className = `px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium 
                                    hover:bg-[var(--vida-module-btn-hover)] transition-colors shadow-sm`;
            startButton.onclick = async () => {
                addMessageToChat('user', startButton.textContent); // Add button text as user message
                suggestedQuestionsContainer.classList.add('hidden'); // Hide start buttons
                suggestedQuestionsContainer.innerHTML = '';
                await generateQuizQuestions(); // Generate questions and start quiz
            };
            suggestedQuestionsContainer.appendChild(startButton);

            const backButton = document.createElement('button');
            backButton.textContent = "Volver a inicio";
            backButton.className = `px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium 
                                    hover:bg-gray-300 transition-colors shadow-sm`;
            backButton.onclick = () => {
                addMessageToChat('user', backButton.textContent); // Add button text as user message
                hideChat(); // Go back to welcome screen
            };
            suggestedQuestionsContainer.appendChild(backButton);
        }

        // Generates quiz questions from Gemini API
        async function generateQuizQuestions() {
            showTypingIndicator(true);
            chatInput.disabled = true;
            chatForm.querySelector('button[type="submit"]').disabled = true;
            suggestQuestionsBtn.disabled = true;

            const quizGenerationPrompt = `
                Eres VIDA, un asistente de donaci√≥n de √≥rganos en M√©xico.
                Tu tarea es generar 10 preguntas de VERDADERO o FALSO sobre mitos y realidades comunes acerca de la donaci√≥n de √≥rganos y tejidos despu√©s de que una persona ha fallecido en M√©xico. Las preguntas deben ser concisas y formuladas para un p√∫blico general, ajeno a la medicina.
                Aseg√∫rate de que las explicaciones sean breves (2-3 l√≠neas m√°ximo), claras, y fundamentadas en informaci√≥n oficial (Ley General de Salud, CENATRA, Reglamento de Trasplantes). No uses asteriscos (*) ni vi√±etas. Si es posible, incluye una referencia breve a la fuente oficial. Las preguntas deben ser variadas y no repetirse.

                Ejemplo de formato de salida JSON (genera 10 objetos en este formato):
                [
                    {"question": "¬øUna persona en coma puede ser donante por muerte encef√°lica?", "isTrue": false, "explanation": "La muerte encef√°lica no es un coma. Es el cese total e irreversible de la funci√≥n cerebral, lo que significa que la persona ha fallecido legal y m√©dicamente. Seg√∫n CENATRA, este es un diagn√≥stico legal de fallecimiento."},
                    {"question": "¬øSi tengo diabetes, no puedo donar √≥rganos?", "isTrue": false, "explanation": "Tener diabetes no siempre impide la donaci√≥n. Un equipo m√©dico eval√∫a cada caso para determinar qu√© √≥rganos y tejidos son aptos para trasplante, seg√∫n los protocolos de salud."},
                    {"question": "¬øEl cuerpo del donante se entrega desfigurado a la familia?", "isTrue": false, "explanation": "La extracci√≥n de √≥rganos se realiza con el m√°ximo respeto y cuidado quir√∫rgico. El cuerpo se restaura para que pueda ser entregado a la familia en condiciones dignas para los servicios funerarios, como establece el Reglamento en materia de trasplantes."},
                    {"question": "¬øSi dono, me desconectar√°n antes para tomar mis √≥rganos?", "isTrue": false, "explanation": "La donaci√≥n solo se considera despu√©s de que se ha certificado legal y m√©dicamente la muerte. Los m√©dicos que atienden al paciente no son parte del equipo de trasplantes, garantizando la √©tica del proceso."},
                    {"question": "¬øEs cierto que las personas ricas tienen prioridad para recibir √≥rganos?", "isTrue": false, "explanation": "La asignaci√≥n de √≥rganos se basa en criterios m√©dicos y de compatibilidad, no en la condici√≥n econ√≥mica o social. Existe una lista de espera nacional gestionada por CENATRA, que prioriza a los pacientes m√°s urgentes y compatibles."}
                ]
            `;

            const payload = {
                contents: [{ role: "user", parts: [{ text: quizGenerationPrompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: { // Corrected schema for object items
                            type: "OBJECT",
                            properties: {
                                "question": { "type": "STRING" },
                                "isTrue": { "type": "BOOLEAN" },
                                "explanation": { "type": "STRING" }
                            },
                            required: ["question", "isTrue", "explanation"]
                        },
                        minItems: 10,
                        maxItems: 10
                    }
                }
            };

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);

                const result = await response.json();
                
                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    try {
                        quizQuestions = JSON.parse(result.candidates[0].content.parts[0].text);
                        // Filter out any potential invalid questions if the parsing returned partial results
                        quizQuestions = quizQuestions.filter(q => q.question && typeof q.isTrue === 'boolean' && q.explanation);
                        if (quizQuestions.length < 10) {
                           console.warn("Generated fewer than 10 valid quiz questions.");
                           addMessageToChat('bot', 'Hubo un problema al generar todas las preguntas del quiz. Por favor, intenta de nuevo.');
                           currentQuizQuestionIndex = -1; // Reset quiz state
                           return;
                        }

                        currentQuizQuestionIndex = 0; // Start with the first question
                        displayQuizQuestion(currentQuizQuestionIndex);
                    } catch (e) {
                        console.error("Error parsing quiz questions JSON:", e);
                        addMessageToChat('bot', 'No pude generar las preguntas del quiz. Por favor, intenta de nuevo. (Error de formato)');
                        currentQuizQuestionIndex = -1; // Reset quiz state
                    }
                } else {
                    addMessageToChat('bot', 'No pude generar las preguntas del quiz. Por favor, intenta de nuevo. (Respuesta vac√≠a)');
                    currentQuizQuestionIndex = -1; // Reset quiz state
                }

            } catch (error) {
                console.error("Error generating quiz questions:", error);
                addMessageToChat('bot', 'Hubo un problema de conexi√≥n al generar el quiz. Por favor, verifica tu conexi√≥n e int√©ntalo de nuevo.');
                currentQuizQuestionIndex = -1; // Reset quiz state
            } finally {
                showTypingIndicator(false);
                chatInput.disabled = false;
                chatForm.querySelector('button[type="submit"]').disabled = false;
                suggestQuestionsBtn.disabled = false;
                chatInput.focus();
            }
        }

        // Displays a single quiz question
        function displayQuizQuestion(index) {
            if (index >= quizQuestions.length) {
                endQuiz(); // All questions asked
                return;
            }

            const questionData = quizQuestions[index];
            // Send the question as a normal bot message
            addMessageToChat('bot', `Pregunta ${index + 1} de ${quizQuestions.length}: ${questionData.question}`);
            
            // Clear previous buttons and ensure container is visible for current question's buttons
            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden'); 

            // Create and append True/False buttons
            const trueBtn = document.createElement('button');
            trueBtn.textContent = "‚úÖ Verdadero";
            trueBtn.className = `px-6 py-3 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] font-bold shadow-md hover:bg-[var(--vida-module-btn-hover)] transition-colors`;
            trueBtn.onclick = () => handleAnswerClick(true, questionData); // Pass questionData
            suggestedQuestionsContainer.appendChild(trueBtn);

            const falseBtn = document.createElement('button');
            falseBtn.textContent = "‚ùå Falso";
            falseBtn.className = `px-6 py-3 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] font-bold shadow-md hover:bg-[var(--vida-module-btn-hover)] transition-colors`;
            falseBtn.onclick = () => handleAnswerClick(false, questionData); // Pass questionData
            suggestedQuestionsContainer.appendChild(falseBtn);

            // Ensure to scroll to bottom after new elements are added
            chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
        }

        // Handles answer click for quiz questions
        function handleAnswerClick(isTrueAnswer, questionData) {
            // Add user's selected answer to chat history
            addMessageToChat('user', isTrueAnswer ? "‚úÖ Verdadero" : "‚ùå Falso");

            // Disable all answer buttons for the current question
            const quizButtons = suggestedQuestionsContainer.querySelectorAll('button');
            quizButtons.forEach(button => {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
                // Optional: visual feedback for correct/incorrect button
                const isCorrectButton = (button.dataset.answer === 'true' && questionData.isTrue) ||
                                       (button.dataset.answer === 'false' && !questionData.isTrue);
                const isSelectedButton = (button.dataset.answer === 'true' && isTrueAnswer) ||
                                         (button.dataset.answer === 'false' && !isTrueAnswer);

                if (isSelectedButton) {
                    if (isCorrectButton) {
                        button.classList.add('bg-[var(--vida-quiz-btn-correct)]', 'text-white');
                    } else {
                        button.classList.add('bg-[var(--vida-quiz-btn-incorrect)]', 'text-white');
                    }
                    button.classList.remove('hover:bg-[var(--vida-module-btn-hover)]');
                }
            });

            // Provide bot's feedback and explanation
            const isCorrect = (isTrueAnswer === questionData.isTrue);
            let feedbackText = isCorrect ? "‚úîÔ∏è ¬°Correcto!" : "‚ùå Incorrecto.";
            feedbackText += `\n${questionData.explanation}`;
            addMessageToChat('bot', feedbackText);

            // Clear True/False buttons and add "Siguiente pregunta" button
            suggestedQuestionsContainer.innerHTML = '';
            const nextQuestionBtn = document.createElement('button');
            nextQuestionBtn.textContent = "‚û°Ô∏è Siguiente pregunta";
            nextQuestionBtn.className = `mt-4 px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium 
                                            hover:bg-[var(--vida-module-btn-hover)] transition-colors shadow-sm`;
            nextQuestionBtn.onclick = () => {
                // This button click will be handled directly here, not via chatForm.requestSubmit()
                addMessageToChat('user', nextQuestionBtn.textContent); // Add button text as user message
                suggestedQuestionsContainer.classList.add('hidden'); // Hide next button
                suggestedQuestionsContainer.innerHTML = '';
                currentQuizQuestionIndex++;
                displayQuizQuestion(currentQuizQuestionIndex);
            };
            suggestedQuestionsContainer.appendChild(nextQuestionBtn);
            suggestedQuestionsContainer.classList.remove('hidden'); // Ensure button is visible
        }


        // Ends the quiz module
        function endQuiz() {
            addMessageToChat('bot', "üéâ ¬°Has completado el Desmitificador Express! Gracias por informarte con VIDA. Cada duda resuelta es un paso m√°s hacia una cultura de donaci√≥n m√°s humana y consciente.");
            
            suggestedQuestionsContainer.innerHTML = ''; // Clear any quiz-related buttons
            suggestedQuestionsContainer.classList.remove('hidden'); // Ensure container is visible

            const startDonorPathBtn = document.createElement('button');
            startDonorPathBtn.textContent = "Iniciar ‚ÄúTu camino como donante‚Äù";
            startDonorPathBtn.className = `px-4 py-2 rounded-lg bg-[var(--vida-btn-green)] text-white text-sm font-bold shadow-md 
                                            hover:bg-[var(--vida-btn-green-hover)] transition-colors`;
            startDonorPathBtn.onclick = () => {
                addMessageToChat('user', startDonorPathBtn.textContent); // Add button text as user message
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                currentQuizQuestionIndex = -1; // End quiz state
                currentDonorPathStep = 'initial'; // Start donor path
                displayDonorPathStep(currentDonorPathStep);
            };
            suggestedQuestionsContainer.appendChild(startDonorPathBtn);

            const askAnotherQuestionBtn = document.createElement('button');
            askAnotherQuestionBtn.textContent = "Hacer otra pregunta a VIDA";
            askAnotherQuestionBtn.className = `px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium 
                                            hover:bg-[var(--vida-module-btn-hover)] transition-colors shadow-sm`;
            askAnotherQuestionBtn.onclick = () => {
                addMessageToChat('user', askAnotherQuestionBtn.textContent); // Add button text as user message
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                currentQuizQuestionIndex = -1; // End quiz state
                chatHistory = []; // Clear history for a fresh general chat
                addInitialBotMessage(); // Restart general chat
            };
            suggestedQuestionsContainer.appendChild(askAnotherQuestionBtn);
        }

    </script>
</body>
</html>
